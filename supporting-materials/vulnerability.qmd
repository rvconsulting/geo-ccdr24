---
title: "Vulnerability Analysis"
subtitle: "Georgia Country Climate and Development Report"
author:
  - name: "Renato Vargas"
    id: rv
    # email: renovargas@gmail.com
    affiliation: 
      - name: Consultant for The World Bank
  # - name: "Julie Rozenberg"
  #   id: nr
  #   # email: 
  #   affiliation: 
  #     - name: The World Bank
format: 
  html:
    toc: true
bibliography: references_vulnerability.bib
editor_options: 
  chunk_output_type: console
---

# Introduction

In analysis, we estimate number of people under vulnerable circumstances.

"The vulnerability of a household to an extreme weather event will depend on the characteristics of the household that determine the event’s initial impact and the ability of a household to cope with that event (...). This is reflected in the IPCC definition, vulnerability includes both 'the sensitivity or susceptibility to harm' and 'the lack of capacity to cope and adapt'" [@doan2023].

# Preliminaries

```{r}
#| warning: false
#| message: false
#| label: preliminaries

# Clean workspace
rm(list = ls())

# Georgia country ISO code
iso <- "GEO"

# Survey year
survey_year <- 2023

# Exchange rate USD per GEL
er <- 0.37

# Years of interest for our macroeconomic scenario analysis
# analysis_years <- c(2030, 2050)
```

We will use the following libraries for this exercise.

```{r}
#| warning: false
#| message: false
#| label: libs

library(tidyverse)
library(haven)
library(readxl)
library(openxlsx)
library(gt)
```

## Datasets 

We use data from the 2023 survey for the Labor Split and data from the 2022 survey for the household expenditure and capital shares in In mil. GEL per year per household type.

```{r}
#| warning: false
#| message: false
#| label: datasets

 #| lst-label: original-datasets

# Household Unique ID, Weights, Location and other basic variables
hh_basics <- read_sav(
  "data/ilcs_2023/sysschedule.sav") |>
  mutate(
    UID = as.integer(UID))

# Household size (includes no. of family members)
hh_size <- read_sav(
  "data/ilcs_2023/familysize.sav")|> 
  mutate(
    UID = as.integer(UID))

# Processed income at household level
hh_income <- read_sav(
  "data/ilcs_2023/tblincomes.sav")|> 
  mutate(
    UID = as.integer(UID))

# Consumption aggregate at household level 
hh_expenditure <- read_sav(
  "data/ilcs_2023/tblexpenditures.sav")|> 
  rename(# rename total expenditure variables
         total_expenditure = MTlianixarjebi_,
         total_expenditure_aeq06 = MTlianimoxmareba_EqAdScale,
         total_expenditure_aeq08 = Mtlianimoxmareba_EqAdScale_08) |> 
  mutate(
    UID = as.integer(UID))

# Characteristics of the dwelling
hh_chars <- read_sav(
  "data/ilcs_2023/tblshinda01.sav")|>
  mutate(
    UID = as.integer(UID))

# Persons (pp)
pp <- read_sav(
  "data/ilcs_2023/tblshinda02.sav") |> 
  mutate(
    UID = as.integer(UID),
    MemberNo = as.integer(MemberNo))

# Labor (pp)
pp_labor <- read_sav(
  "data/ilcs_2023/tblshinda05_1.sav") |> 
  mutate(
    UID = as.integer(UID),
    MemberNo = as.integer(MemberNo),
    Q5  = as.integer(Q5),
    Q12 = as.integer(Q12)) 

# Poverty
poverty <- read_dta(
  "data/ilcs_2023/POVERTY_stata.dta") |> 
  mutate(
    UID = as.integer(UID))

# Ind. Poverty
ind_poverty <- read_dta(
  "data/ilcs_2023/IND_POVERTY_stata.dta") |> 
  rename(MemberNo = memberno) |> 
  mutate(
    UID = as.integer(UID),
    MemberNo = as.integer(MemberNo))

# Exposure
floods <- read.csv(
  "data/exposure/floods/df_exposure_100.csv"
)
region_lookup <- floods |>
  filter(
    scenario == "2020"
  ) |> 
  select(
    RegNo,
    regions) |> 
  arrange(RegNo)

```

## Look-up tables

```{r}
#| warning: false
#| message: false
#| label: look-up-tables

sam_activities <- read_excel(
    "data/sam/classifications.xlsx",
    sheet = "SAM-REV2",
    col_names = T,
    col_types = "text",
  )

sam_factors <- read_excel(
    "data/sam/classifications.xlsx",
    sheet = "SAM factors",
    col_names = T,
    col_types = "text",
  )

coicop <- read_excel(
    "data/sam/classifications.xlsx",
    sheet = "COICOP",
    col_names = T,
    col_types = "text",
  ) |> 
  mutate(simple_code = as.integer(gsub("\\.", "", Coicop)))

coicop_filtered <- coicop |> 
  filter( nchar(as.character(simple_code)) >= 5)

```

# Vulnerability indicators

## Income

Following the methodology [@doan2023] this identifies the share of households that have income or consumption less than 1.5 times the poverty line. In the guidance paper, they use $2.15 (2017 PPP), but in our case, we use the official poverty line of Georgia for the year 2023 of 212.81 GEL per cápita (adult equivalent) per month. To be consistent with country assessments, we use consumption and not income, but to be consistent with the methodology paper, we continue to call this variable income.

```{r}
#| warning: false
#| message: false
#| label: vulnerability-income

# Poverty line
poverty_line <- poverty$pline[1]
income_threshold <- poverty_line * 1.5

hh_vulnerable <- poverty |> 
  select(
    QuartNo,
    UID,
    DiaryID,
    RegNo,
    type,
    weights_quar, # Sampling weights of the HH
    weights,      # HH weights
    aecons,
    aeinc,
    pline) |> 
  mutate(
    vulnerability_income = if_else(
      aecons < income_threshold, 1, 0))
```

## Education

Education to switch livelihoods or to access information and resources is proxied by a variable reflecting whether the household has an adult that has completed primary education.  The GMD is used because this allows us to have information on education and income for the same household which allows us to know whether an individual is deprived on one or both dimensions [@doan2023]. The `poverty` dataset already has the education level of the head of household. However, this calls for any member having at least primary education, which makes sense, because literate family members often bridge the understanding gap for illiterate ones, regardless of head of family status.

```{r}
#| warning: false
#| message: false
#| label: vulnerability-education

vulnerable_education <- pp |>
  select(UID, Education) |> 
  mutate(
    educated_member = case_when(
      Education < 4 ~ 0, # "4. Primary education"
      Education >= 4 ~ 1,
      TRUE ~ 0 )) |> 
  group_by(UID) |> 
  summarize(
    educated_members = sum(educated_member, na.rm = T),
    vulnerability_education = if_else(
      educated_members == 0, 1, 0
    )
  ) |> 
  select(-educated_members)

educ_vulnerable_hh_unweighted <- sum(
  vulnerable_education$vulnerability_education)
```

In the entire dataset `{r} educ_vulnerable_hh_unweighted` households (unweighted) meet the education vulnerability criteria. Among the survey households, up to 9 members could be educated with the following distribution. This is a positive metric for Georgia.

## Access to water

"When shocks hit, access to these services is an important determinant of the impact of the shock on welfare. For example, with access to improved drinking water, contaminated water from flooding and storms, or lack of water due to drought has less of an impact. Nevertheless, it is essential to acknowledge that the current indicator of access to improved drinking water, often represented by covered wells in low-income countries, may not sufficiently reflect susceptibility to contamination during extreme events such as floods or droughts. Therefore, there is a need for future work to refine this indicator by considering a potentially higher threshold. Metrics such as “improved piped water” can offer a more precise assessment of the infrastructure safeguarding against water-related risks in the event of shocks." [@doan2023]

We take note of this caveat and choose the threshold water supply system installed in the dwelling and water system tap in the yard or vicinity as counting towards this dimension from the possible options below:

1. The water supply system installed in the dwelling
2. The water system tap in the yard or vicinity
3. The well in the yard or vicinity
4. Natural spring in the yard or vicinity
5. River, lake, spring, channel
6. Bought water
7. Other

```{r}
#| warning: false
#| message: false
#| label: vulnerability-water

vulnerable_water <- poverty |> 
  select(UID, WaterSource) |> 
  mutate(
    vulnerability_water = if_else(
      WaterSource < 3, 0, 1)) |> 
  select(-WaterSource)

# We check the distribution

as.data.frame(table(vulnerable_water$vulnerability_water)) |> 
  gt()
```

## Access to electricity

"With access to electricity, households are more likely to have assets such as fans that can help with heatwaves. A fuller discussion is available in the World Bank’s Lifelines report (Hallegatte et al, 2019). Whilst not a final selection of assets and infrastructure that matter for determining the initial loss of the shock, these measures provide a good first estimate to stimulate discussion." [@doan2023] Variable `q11_3` from the poverty dataset is a dummy that determines whether the household has access to electricity.

```{r}
#| warning: false
#| message: false
#| label: vulnerability-electricity

vulnerable_electricity <- poverty |> 
  select(UID, q11_3) |> 
  mutate(
    vulnerability_electricity = if_else(
      q11_3 != 1, 1, 0)) |> 
  select(-q11_3)

# We check the distribution

as.data.frame(table(vulnerable_electricity$vulnerability_electricity)) |> 
  gt()
```

Now, this is not a source of variation in the case of Georgia, since 100% of households report having access to electricity, but the methodology also mentions that "Access to markets and services, access to early warning systems, sanitation, and building and infrastructure quality are also playing a key role in determining disasters’ impacts, and has been included in other estimates, but is left for future inclusion here." [@doan2023]. Both sanitation and building infrastructure quality, proxied by wall materials could be included in Georgia's estimates. When it comes to sanitation, there is still a gap that the country needs to close. 

## Access to sanitation

For this variable (`TypeOfToilet`) we have the following categories, of which we choose "own flush toilet connected to the sewerage system" and "shared flush toilet connected to the sewerage system" as having access to sanitation.

1. Own flush toilet connected to the sewerage system
2. Shared flush toilet connected to the sewerage system
3. Flush latrine not connected to the sewerage system (connected to the river, chan
4. Pit latrine periodically cleaned or finally filled up and buried
5. Other

```{r}
#| warning: false
#| message: false
#| label: vulnerability-sanitation

vulnerable_sanitation <- poverty |> 
  select(UID, TypeOfToilet) |> 
  mutate(
    vulnerability_sanitation = if_else(
      TypeOfToilet < 3, 0, 1)) |> 
  select(-TypeOfToilet)

# We check the distribution

as.data.frame(table(vulnerable_sanitation$vulnerability_sanitation)) |> 
  gt()
```

## Building materials

When it comes to building materials of walls and floor, data show that the most precarious categories (mud walls, and bare ground floors) are not present in the country. We will still count concrete walls as not vulnerable and wood as vulnerable, but only relative to each other, not making any assumptions about the quality of wood structures in Georgia.

```{r}
#| warning: false
#| message: false
#| label: vulnerability-buildings

vulnerable_building <- poverty |> 
  select(UID, Walls) |> 
  mutate(
    vulnerability_building = if_else(
      Walls %in% c(1,3), 0, 1)) |> 
  select(-Walls)

# We check the distribution

as.data.frame(table(
  vulnerable_building$vulnerability_building)) |> 
  gt()
```

## Social protection

"The third dimension of inability to cope is access to public support. There is considerable evidence that cash transfers help households to manage shocks (...) [T]here is some evidence in favor of using information on current coverage, as support is more likely to be available in response to a disaster in places where pre-disaster coverage rates are high." [@doan2023] In the `poverty` dataset the variable `S_Q2b` shows those households that actually received social protection benefits.

```{r}
#| warning: false
#| message: false
#| label: vulnerability-ssp

vulnerable_ssp <- poverty |> 
  select(UID, S_Q2b) |> 
  mutate(
    vulnerability_ssp = if_else(
      coalesce(S_Q2b, 0) == 1, 0, 1)) |> 
  select(-S_Q2b)

# We check the distribution

as.data.frame(table(
  vulnerable_ssp$vulnerability_ssp)) |> 
  gt()
```

## Financial services

"The variable we use indicates whether a respondent has either a financial institution account or a mobile money account, given the strong relationship in the literature on access to mobile money and ability to use informal networks to manage the impact of large climate shocks." [@doan2023] The `poverty` dataset has information on amount saved by the household, which we will use as proxy for access to some financial security. We cannot assert that the money is being saved in a proper financial institution. However, we assume that having monthly level of savings of any kind can mitigate the impacts of climate change.

```{r}
#| warning: false
#| message: false
#| label: vulnerability-financial

vulnerable_financial <- poverty |> 
  select(UID, DazogvaAnCasesxeba) |> 
  mutate(
    vulnerability_financial = if_else(
      coalesce(DazogvaAnCasesxeba, 0) == 0, 1, 0)) |> 
  select(-DazogvaAnCasesxeba)

# We check the distribution

as.data.frame(table(
  vulnerable_financial$vulnerability_financial)) |> 
  gt()
```

## Join vulnerability datasets

```{r}
#| warning: false
#| message: false
#| label: vulnerability-join

# List of data frames to join
vulnerable_data <- list(
  vulnerable_education,
  vulnerable_water,
  vulnerable_electricity,
  vulnerable_sanitation,
  vulnerable_building,
  vulnerable_ssp,
  vulnerable_financial
)

# Start with the initial data frame
for (df in vulnerable_data) {
  hh_vulnerable <- hh_vulnerable |> left_join(df, join_by(UID))
}
```

